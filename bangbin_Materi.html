<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATERI DAN TUJUAN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/1_4llqCMNoBDmwDHsI7RYsCM6rSK5wEjw">	
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* === DESAIN MODERN & CERAH === */
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --primary-hover: #2563eb; /* Blue 600 */
            --success-color: #16a34a; /* Green 600 */
            --danger-color: #dc2626;  /* Red 600 */
            --bg-color: #f3f4f6;      /* Gray 100 */
            --panel-bg: #ffffff;
            --font-color: #1f2937;    /* Gray 800 */
            --font-light: #6b7280;   /* Gray 500 */
            --border-color: #e5e7eb;  /* Gray 200 */
            --border-radius: 0.75rem; /* 12px */
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        body {
            font-family: 'Poppins', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
        }

        .animated-panel {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .main-panel {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .btn-primary {
            display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem; padding: 0.75rem 1.5rem; font-weight: 600;
            border: none; border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            cursor: pointer; transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow);
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background-color: var(--panel-bg);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .btn-secondary:hover {
            background-color: #eff6ff; /* Blue 50 */
            color: var(--primary-hover);
        }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }

        .input-field, .select-field {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color);
            border-radius: var(--border-radius); background-color: #f9fafb;
            color: var(--font-color); font-family: 'Poppins', sans-serif; font-size: 1em;
            transition: all 0.2s ease;
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .input-field:disabled, .select-field:disabled {
            color: var(--font-light);
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .modal-backdrop {
            position: fixed; inset: 0;
            background-color: rgba(17, 24, 39, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease forwards;
        }
        .modal-content {
            background-color: var(--panel-bg);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            width: 90%; max-width: 500px;
            display: flex; flex-direction: column;
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .table-wrapper {
            max-height: 65vh; overflow: auto; position: relative;
        }
        .table-wrapper thead th {
            position: sticky; top: 0; z-index: 10;
            background-color: #f9fafb; /* Lighter than panel bg for contrast */
            border-bottom: 2px solid var(--border-color);
            color: var(--font-light);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        #spreadsheet-body tr {
            animation: fadeIn 0.5s ease-out forwards;
            transition: background-color 0.2s ease;
        }
        #spreadsheet-body tr:hover {
            background-color: #f9fafb;
        }
        #spreadsheet-body td {
            background: white;
            border-bottom: 1px solid var(--border-color);
        }
        #spreadsheet-body tr:first-child td:first-child { border-top-left-radius: var(--border-radius); }
        #spreadsheet-body tr:first-child td:last-child { border-top-right-radius: var(--border-radius); }
        #spreadsheet-body tr:last-child td:first-child { border-bottom-left-radius: var(--border-radius); }
        #spreadsheet-body tr:last-child td:last-child { border-bottom-right-radius: var(--border-radius); }
        #spreadsheet-body tr:last-child td { border-bottom: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg shadow-sm mb-8 rounded-xl">
        <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">MATERI DAN Tujuan Pembelajaran</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="status-display" class="text-sm font-medium text-gray-600 hidden md:block"></div>
                    <a href="./" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition" title="Halaman Utama">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    </a>
                    <button id="dataOptionsBtn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition" title="Unduh Excel">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <main class="w-full max-w-7xl mx-auto space-y-8">
        <div id="filter-panel" class="main-panel animated-panel grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div><label for="filter-fase" class="block text-sm font-medium text-gray-700 mb-2">Fase</label><select id="filter-fase" class="select-field"><option value="">Semua Fase</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select></div>
            <div><label for="filter-kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filter-kelas" class="select-field"><option value="">Semua Kelas</option></select></div>
            <div><label for="filter-pelajaran" class="block text-sm font-medium text-gray-700 mb-2">Pelajaran</label><select id="filter-pelajaran" class="select-field"><option value="">Semua Pelajaran</option></select></div>
            <div><label for="filter-materi" class="block text-sm font-medium text-gray-700 mb-2">Materi</label><input type="text" id="filter-materi" placeholder="Cari materi..." class="input-field"></div>
        </div>

        <div class="main-panel animated-panel" style="animation-delay: 0.1s;">
            <div class="table-wrapper">
                <table class="w-full" style="border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th class="p-3 text-left" style="width: 5%;">Fase</th>
                            <th class="p-3 text-left" style="width: 10%;">Kelas</th>
                            <th class="p-3 text-left" style="width: 20%;">Pelajaran</th>
                            <th class="p-3 text-left" style="width: 20%;">Materi</th>
                            <th class="p-3 text-left" style="width: 45%;">Tujuan Pembelajaran</th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheet-body">
                    </tbody>
                </table>
            </div>
            <div id="pagination-controls" class="flex justify-between items-center mt-6">
                <button id="prev-page-btn" class="btn-primary btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    Sebelumnya
                </button>
                <span id="page-info" class="font-semibold text-gray-600"></span>
                <button id="next-page-btn" class="btn-primary btn-secondary">
                    Berikutnya
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>
    </main>
    
    <div id="dataModal" class="modal-backdrop hidden items-center justify-center p-4">
        <div class="modal-content p-8">
             <h3 class="text-2xl font-bold mb-2 text-gray-800">Opsi Data Excel</h3>
             <p class="text-gray-500 mb-6">Unduh data yang ditampilkan ke dalam format file Excel (.xlsx).</p>
             <button id="exportBtn" class="w-full btn-primary btn-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Unduh Data
             </button>
             <div class="mt-6 text-center">
                <button class="close-modal-btn font-semibold text-gray-500 hover:text-gray-700">Tutup</button>
             </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2Sf-7Nac2tdDewnQRrpsce5QrEtaGFyDSczNF7IaInEwk6Jqfm6a7H0uqwUsKoIPV/exec";
            const pelajaranOptions = ["Pendidikan Agama Islam dan Budi Pekerti", "Pendidikan Agama Protestan dan Budi Pekerti", "Pendidikan Agama Katholik dan Budi Pekerti", "Pendidikan Agama Hindu dan Budi Pekerti", "Pendidikan Agama Budha dan Budi Pekerti", "Pendidikan Agama Konghucu dan Budi Pekerti", "Pendidikan Pancasila", "Bahasa Indonesia", "Matematika", "Ilmu Pengetahuan Alam dan Sosial", "Seni Rupa", "Seni Musik", "Seni Teater", "Seni Tari", "Koding dan Kecerdasan Buatan", "Pendidikan Lingkungan dan Budaya Jakarta", "Pendidikan Jasmani Olahraga dan Kesehatan", "Bahasa Inggris", "Bahasa Bali", "Bahasa Sunda", "Bahasa Jawa", "Bahasa Padang"];

            let allData = [];
            let filteredData = [];
            let currentPage = 1;
            const rowsPerPage = 10;

            const tableBody = document.getElementById('spreadsheet-body');
            const statusDisplay = document.getElementById('status-display');
            const filterFase = document.getElementById('filter-fase');
            const filterKelas = document.getElementById('filter-kelas');
            const filterPelajaran = document.getElementById('filter-pelajaran');
            const filterMateri = document.getElementById('filter-materi');
            const pageInfo = document.getElementById('page-info');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const dataModal = document.getElementById('dataModal');
            const dataOptionsBtn = document.getElementById('dataOptionsBtn');
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');
            const exportBtn = document.getElementById('exportBtn');

            const setStatus = (message, isWorking = false, duration = 3000) => {
                statusDisplay.textContent = message;
                if (!isWorking && message) {
                    setTimeout(() => statusDisplay.textContent = "", duration);
                }
            };

            const createRowElement = (rowData) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-3"><div class="input-field" disabled>${rowData.fase || ''}</div></td>
                    <td class="p-3"><div class="input-field" disabled>Kelas ${rowData.kelas || ''}</div></td>
                    <td class="p-3"><div class="input-field" disabled>${rowData.pelajaran || ''}</div></td>
                    <td class="p-3"><div class="input-field" disabled>${rowData.materi || ''}</div></td>
                    <td class="p-3"><div class="input-field" disabled>${rowData.tujuan || ''}</div></td>`;
                
                // Ganti input/select/textarea dengan div untuk tampilan baca-saja yang lebih bersih
                row.querySelectorAll('td > div').forEach(div => {
                    div.style.height = '100%';
                    div.style.minHeight = '50px';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                });

                return row;
            };

            const displayPage = (page) => {
                currentPage = page;
                tableBody.innerHTML = '';
                const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (totalPages === 0) {
                    pageInfo.textContent = 'Tidak ada data ditemukan';
                    prevPageBtn.disabled = true;
                    nextPageBtn.disabled = true;
                    return;
                }
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const paginatedItems = filteredData.slice(start, end);
                paginatedItems.forEach(rowData => tableBody.appendChild(createRowElement(rowData)));
                pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            };

            const applyFilters = () => {
                const fase = filterFase.value;
                const kelas = filterKelas.value;
                const pelajaran = filterPelajaran.value;
                const materi = filterMateri.value.toLowerCase();
                filteredData = allData.filter(row => 
                    (fase === "" || row.fase === fase) &&
                    (kelas === "" || String(row.kelas) === kelas) &&
                    (pelajaran === "" || row.pelajaran === pelajaran) &&
                    (materi === "" || (row.materi && row.materi.toLowerCase().includes(materi)))
                );
                displayPage(1);
            };
            
            const fetchData = async () => {
                setStatus("Memuat data...", true);
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL);
                    const result = await response.json();
                    if (result.success) {
                        allData = result.data;
                        applyFilters();
                        setStatus("Data berhasil dimuat.", false);
                    } else { throw new Error(result.message); }
                } catch (error) {
                    setStatus(`Gagal memuat: ${error.message}`, false);
                    allData = [];
                    applyFilters();
                }
            };

            pelajaranOptions.forEach(p => { filterPelajaran.innerHTML += `<option value="${p}">${p}</option>`; });
            Array.from({length: 12}, (_, i) => i + 1).forEach(k => { filterKelas.innerHTML += `<option value="${k}">Kelas ${k}</option>`; });
            
            [filterFase, filterKelas, filterPelajaran, filterMateri].forEach(el => el.addEventListener('input', applyFilters));

            prevPageBtn.addEventListener('click', () => { if (currentPage > 1) displayPage(currentPage - 1); });
            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (currentPage < totalPages) displayPage(currentPage + 1);
            });

            const openModal = (modal) => { modal.classList.remove('hidden'); modal.classList.add('flex') };
            const closeModal = (modal) => { modal.classList.add('hidden'); modal.classList.remove('flex') };
            dataOptionsBtn.addEventListener('click', () => openModal(dataModal));
            closeModalBtns.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop'))));
            dataModal.addEventListener('click', e => { if (e.target === dataModal) closeModal(dataModal); });

            exportBtn.addEventListener('click', async function() {
                const button = this;
                button.disabled = true;
                button.textContent = 'Memproses...';
                try {
                    const workbook = new ExcelJS.Workbook();
                    const mainSheet = workbook.addWorksheet('BANGBIN_TP');
                    mainSheet.columns = [
                        { header: 'Fase', key: 'fase', width: 12 },
                        { header: 'Kelas', key: 'kelas', width: 12 },
                        { header: 'Pelajaran', key: 'pelajaran', width: 45 },
                        { header: 'Materi', key: 'materi', width: 45 },
                        { header: 'Tujuan Pembelajaran', key: 'tujuan', width: 60 },
                        { header: 'ID', key: 'id', width: 40 }
                    ];
                    mainSheet.getRow(1).eachCell((cell) => {
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF3B82F6' } };
                        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                        cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    });
                    filteredData.forEach(rowData => {
                        mainSheet.addRow({
                            fase: rowData.fase,
                            kelas: `Kelas ${rowData.kelas}`,
                            pelajaran: rowData.pelajaran,
                            materi: rowData.materi,
                            tujuan: rowData.tujuan,
                            id: rowData.id
                        });
                    });
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'Bangbin_TP_Export.xlsx';
                    document.body.appendChild(a); a.click();
                    window.URL.revokeObjectURL(url); document.body.removeChild(a);
                } catch (error) {
                    console.error("Gagal membuat file Excel:", error);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Unduh Data';
                }
            });

            fetchData();
        });
    </script>
</body>
</html>

